{"version":3,"file":"enveloped-signature.js","sourceRoot":"","sources":["../src/enveloped-signature.ts"],"names":[],"mappings":";;;AAAA,+BAA+B;AAQ/B,MAAa,kBAAkB;IAA/B;QACE,oBAAe,GAAG,KAAK,CAAC;IA6C1B,CAAC;IA5CC,OAAO,CAAC,IAAU,EAAE,OAAgE;QAClF,IAAI,IAAI,IAAI,OAAO,CAAC,aAAa,EAAE;YACjC,MAAM,SAAS,GAAG,KAAK,CAAC,OAAO,CAC7B,0FAA0F,EAC1F,IAAI,CACL,CAAC;YACF,IAAI,KAAK,CAAC,UAAU,CAAC,SAAS,CAAC,IAAI,SAAS,CAAC,UAAU,EAAE;gBACvD,SAAS,CAAC,UAAU,CAAC,WAAW,CAAC,SAAS,CAAC,CAAC;aAC7C;YACD,OAAO,IAAI,CAAC;SACb;QACD,MAAM,aAAa,GAAG,OAAO,CAAC,aAAa,CAAC;QAC5C,MAAM,sBAAsB,GAAG,KAAK,CAAC,OAAO,CAC1C,6CAA6C,EAC7C,aAAa,CACd,CAAC;QACF,IAAI,KAAK,CAAC,UAAU,CAAC,sBAAsB,CAAC,EAAE;YAC5C,MAAM,0BAA0B,GAAG,sBAAsB,CAAC,IAAI,CAAC;YAE/D,MAAM,UAAU,GAAG,KAAK,CAAC,MAAM,CAC7B,2FAA2F,EAC3F,IAAI,CACL,CAAC;YACF,KAAK,MAAM,aAAa,IAAI,KAAK,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC,EAAE,EAAE;gBACvE,MAAM,cAAc,GAAG,KAAK,CAAC,OAAO,CAClC,6CAA6C,EAC7C,aAAa,CACd,CAAC;gBACF,IAAI,KAAK,CAAC,UAAU,CAAC,cAAc,CAAC,EAAE;oBACpC,MAAM,kBAAkB,GAAG,cAAc,CAAC,IAAI,CAAC;oBAC/C,IAAI,0BAA0B,KAAK,kBAAkB,EAAE;wBACrD,IAAI,aAAa,CAAC,UAAU,EAAE;4BAC5B,aAAa,CAAC,UAAU,CAAC,WAAW,CAAC,aAAa,CAAC,CAAC;yBACrD;qBACF;iBACF;aACF;SACF;QACD,OAAO,IAAI,CAAC;IACd,CAAC;IAED,gBAAgB;QACd,OAAO,uDAAuD,CAAC;IACjE,CAAC;CACF;AA9CD,gDA8CC","sourcesContent":["import * as xpath from \"xpath\";\n\nimport type {\n  CanonicalizationOrTransformationAlgorithm,\n  CanonicalizationOrTransformationAlgorithmProcessOptions,\n  CanonicalizationOrTransformAlgorithmType,\n} from \"./types\";\n\nexport class EnvelopedSignature implements CanonicalizationOrTransformationAlgorithm {\n  includeComments = false;\n  process(node: Node, options: CanonicalizationOrTransformationAlgorithmProcessOptions) {\n    if (null == options.signatureNode) {\n      const signature = xpath.select1(\n        \"./*[local-name(.)='Signature' and namespace-uri(.)='http://www.w3.org/2000/09/xmldsig#']\",\n        node,\n      );\n      if (xpath.isNodeLike(signature) && signature.parentNode) {\n        signature.parentNode.removeChild(signature);\n      }\n      return node;\n    }\n    const signatureNode = options.signatureNode;\n    const expectedSignatureValue = xpath.select1(\n      \".//*[local-name(.)='SignatureValue']/text()\",\n      signatureNode,\n    );\n    if (xpath.isTextNode(expectedSignatureValue)) {\n      const expectedSignatureValueData = expectedSignatureValue.data;\n\n      const signatures = xpath.select(\n        \".//*[local-name(.)='Signature' and namespace-uri(.)='http://www.w3.org/2000/09/xmldsig#']\",\n        node,\n      );\n      for (const nodeSignature of Array.isArray(signatures) ? signatures : []) {\n        const signatureValue = xpath.select1(\n          \".//*[local-name(.)='SignatureValue']/text()\",\n          nodeSignature,\n        );\n        if (xpath.isTextNode(signatureValue)) {\n          const signatureValueData = signatureValue.data;\n          if (expectedSignatureValueData === signatureValueData) {\n            if (nodeSignature.parentNode) {\n              nodeSignature.parentNode.removeChild(nodeSignature);\n            }\n          }\n        }\n      }\n    }\n    return node;\n  }\n\n  getAlgorithmName(): CanonicalizationOrTransformAlgorithmType {\n    return \"http://www.w3.org/2000/09/xmldsig#enveloped-signature\";\n  }\n}\n"]}